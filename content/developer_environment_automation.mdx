# Developer Environment and Automation

<img src={'https://images.unsplash.com/photo-1505238680356-667803448bb6?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80'} altText />

For more than 7 years I have been working professionally as a Software Engineer. During this time I put together a nice developer setup. This article is my attempt to review it, improve it and share it with others.

Most of the time I spend in **command line**, writing code in **Vim**, executing commands in **Zsh** shell, switching panes and sessions in **Tmux**  and all that is rendered in **Alacritty** terminal emulator running on my Mac.

What my developer environment consists of?

* MacOS as main operation system
* Ansible for installation and configuration
* Alacritty as a terminal emulator
* ZSH as command interpreter (shell)
* Tmux as a terminal multiplexer (sessions, panes)
* Nvim as the main text editor

## Table of Contents

## Automation

Manual installation and configuration is hard, confusing and takes a lot of time. My machine setted up fully automatically, using provisional scripts, package managers and plain text confuguration files.

### Package managers

Package managers automate process of installation, configuration, upgrading and removing programs. Most used on Mac is [homebrew](https://brew.sh).

Usage examples:

Install `Google Chrome`:

```sh
brew cask install google-chrome
```

List all installed:

```sh
brew cask list
```

Upgrade Google Chrome:

```sh
brew upgrade google-chrome
```

Uninstall Google Chrome:

```sh
brew uninstall google-chrome
```

### Dotfiles

Dotfiles are used to customize, configure and extend programs. They are plain text files, located in home directory and usually loaded automatically.

Examples: `.profile.clj`, `.tmux.conf`, `.vimrc`, `.zshrc`.

### Ansible

All setup instructions are in Ansible provisioning scripts and stored on github in [env-automation][env-automation] project. Applications represented as roles (tasks, templates and variables) and executed by Ansible.

Ansible provides:
* variables management
* `ansible-vault` for secrets
* templating for config files
* plugins to work with git, brew, curl

For example Nvim role, installs package from brew and generates `.nvimrc` 

```yml
---
- name: Make sure Nvim is present
  homebrew:
    name:
      - neovim
    state: present

- name: Make sure .nvimrc is present
  template:
    src: templates/.nvimrc
    dest: ~/.nvimrc
```

Apply Nvim role:

```
ansible-playbook -i hosts playbook.yml --tags=nvim
```

Playbook defines list of roles for installation:

```yml
---
- hosts: local
  vars_files:
    - vars/variables.yml
  roles:
    - {role: 'macos', tags: 'macos'}
    - {role: 'packages', tags: 'packages'}
    - {role: 'git', tags: 'git'}
    - {role: 'python', tags: 'python'}
    - {role: 'ssh', tags: 'ssh'}
    - {role: 'asdf-vm', tags: 'asdf-vm'}
    - {role: 'zsh', tags: 'zsh'}
    - {role: 'tmux', tags: 'tmux'}
    - {role: 'vim', tags: 'vim'}
    - {role: 'alacritty', tags: 'alacritty'}
    - {role: 'aws', tags: 'aws'}
    - {role: 'golang', tags: 'golang'}
    - {role: 'jvm', tags: 'jvm'}
    - {role: 'clojure', tags: 'clojure'}
    - {role: 'docker', tags: 'docker'}
    - {role: 'node', tags: 'node'}
```

## Alacritty

When you havily use command line, espessially when you search, move around, or write code in Nvim - you expect you terminal to render text fast. At some point I was frustrated with performance of my terminal and found a solution - [Alacritty][Alacritty Github].

> Alacritty is the fastest terminal emulator in existence.

Alacritty is fast and simple. It is written in Rust and uses GPU acceleration for rendering. There is no GUI features like windows, tabs or splits. It's just one very performant window. For tabs and splits I am using `Tmux`.

Alacritty ansible role:

```yml
---
- name: Make sure alacritty is present
  homebrew_cask:
    name: alacritty
    state: present

- name: Make sure config directory is present
  file:
    path: ~/.config/alacritty
    state: directory

- name: Make sure config file is present
  template:
    src: templates/alacritty.yml.j2
    dest: ~/.config/alacritty/alacritty.yml
```

I'm using it with `Fira Code` font, it doesn't support font ligatures.

```yml
font:
  normal:
    family: Fira Code
    style: Regular
  bold:
    family: Fira Code
    style: Bold
  italic:
    family: Fira Code
    style: Italic
  size: 14.0
```

Setup default shell - `Zsh`

```yml
shell:
  program: /usr/local/bin/zsh
  args:
    - --login
```

I added next line to be able to use `^`, when you type `<ctrl>6`, in Nvim to switch between files:
```yml
key_bindings:
  - {key: Key6, mods: Control, chars: "\x1e"}
```

Full Alacritty configuration is here [.alacritty.yml](https://github.com/atsman/env-automation/blob/master/roles/alacritty/templates/alacritty.yml.j2)

## Tmux

[Tmux][Tmux Github] is a terminal multiplexer which allows to have multiple sessions, windows and splits in one terminal window.

* **sessions**: list of terminals Tmux control, each has one or more windows
* **window**: window takes one screen and can be splitted into panes
* **pane**: smallest part of the window

Usually I have session per project open and multiple windows in each session. For example I can have session `work`, with 2 windows open, one for code in Nvim and one window for running build scripts and tests.

Tmux allows to quickly navigate between sessions, windows and panes. With some additional configuration you can get Vim key bindings to jump between splits, browse logs and copy paste text.

### Plugins

[Tmux Plugin Manager (tmp)](https://github.com/tmux-plugins/tpm) is used to simplify plugins management. It has to be cloned to `~/.tmux/plugins/tpm`.

```tmux
# predefined settings
set -g @plugin 'tmux-plugins/tmux-sensible'

# copy to system clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# regex search
set -g @plugin 'tmux-plugins/tmux-copycat'

# open highlighted selection
set -g @plugin 'tmux-plugins/tmux-open'
```

* [tmux-plugins/tpm](https://github.com/tmux-plugins/tpm) - plugin manager 
* [tmux-plugins/tmux-sensible](https://github.com/tmux-plugins/tmux-sensible) - predefined settings
* [tmux-plugins/tmux-yank](https://github.com/tmux-plugins/tmux-yank) - copy to system clipboard
* [tmux-plugins/tmux-copycat](https://github.com/tmux-plugins/tmux-copycat) - regex search
* [tmux-plugins/tmux-open](https://github.com/tmux-plugins/tmux-open) - open highlighted selection
* [vim-tmux-navigator](https://github.com/christoomey/vim-tmux-navigator) - seamless navigation between tmux and vim

### Vim-like copy paste

```
# starts selection mode
bind C-[ copy-mode
bind -T copy-mode-vi 'v' send -X begin-selection

# copy with 'enter' or 'y' and send to mac os clipboard: http://goo.gl/2Bfn8
unbind -T copy-mode-vi Enter
bind -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"

# paste
bind p paste-buffer

# paste from system clipboard MacOS
bind C-v run \"tmux set-buffer \"$(reattach-to-user-namespace pbpaste)\"; tmux paste-buffer"
```

### Vim-like pane navigation

If you don't use fzf, you can just install plugin:
```
set -g @plugin 'christoomey/vim-tmux-navigator'
```

To be able to use navigation in fzf window, fzf needs to be added to is_vim check.

```
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|fzf|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l
```

### Shortcuts

Most of the shortcuts have a prefix key as part of them. My prefix is `<ctrl>a`. For example to create new window `<prefix> c`, I have to hold `<ctrl>a` + `c`. 

```
<c-a> - Prefix
<prefix>r - reload config
```

#### Sessions

```
<prefix>:new -s <session-name> - creates new session
<prefix>s - open session list
<prefix>w - open session list with tabs
```

#### Windows 

```
<prefix>c - create new window
<prefix>h - toggle window line
<prefix>1 - go to window 1
<prefix>2 - go to window 2
.
<prefix><N> - go to window N
```

#### Splits

```
<prefix>| - vertical split
<prefix>- - horizontal split
```

#### Navigation

```
<ctrl>h - go to left split
<ctrl>l - go to right split
<ctrl>k - go to top split
<ctrl>j - go to bottom split
```

#### Copy mode

```
<prefix><c-]> - activate copy mode
v - start copy selection
y - copy selection
p - paste selection
```

Here you can find full [.tmux.config](https://github.com/atsman/env-automation/blob/master/roles/tmux/templates/.tmux.conf.j2)

## Nvim 

> [Nvim][Neovim Github] - a community-driven, refactored version of vim.

Nvim allows me to edit text faster than anything else. It designed to keep hands always in an optimum position to input text, to scroll, to navigate or to apply commands.

Config files are here: [.nvimrc](https://github.com/atsman/env-automation/tree/master/roles/nvim/templates)

### Plugins

[vim-plug][VimPlug Github] is used to simplify plugin management. It supports on-demand plugin loading for start time fast, and parallel installation / updates.

* File explorer - [nerdtree][Nerdtree Github]
* Navigation / Search - [fzf][FZF Github], [fzf.vim][FZF Vim Github], [ripgrep][RipGrep Github]
* Autocomplete - [YouCompleteMe][YCM Github]
* Linting - [ale][Ale Github]
* Git - [vim-fugitive][Vim Fugitive Github], [vim-gitgutter][Vim GitGutter Github], [gv.vim][GV Github]

### File explorer

The [Nerdtree][Nerdtree Github] presents filesystem in the form of the tree and allows to browse, navigate and manipulate files and directories using Nvim navigation shortcuts.

### Navigation / Search

Search and navigation is done via [fzf][FZF Github]. It is a generic command-line fuzzy finder. It can be used to search in any list: files, command history, processes, hostnames, bookmarks, git commits. From the shell it is used to execute commands from command history, to select git branches, to choose npm scripts and so on.

From inside of the editor it is used via [fzf.vim][FZF Vim Github] to search for files by filename and to quickly jump between buffers. To search by files content, fzf is used in conjunction with [ripgrep][RipGrep Github], which is grep rewritten in rust.

### Autocomplete

Having editor to predict what are you going to type is must have nowadays. So far the expirience with autocompletion I had with [YouCompleteMe][YCM Github].

### Linting

While writing code automatic formating and linting is must-have. The best vim plugin for that is [Ale][Ale Github]. It provides integration with most linting, formating tools and to LSP servers. 

Reasons to use it:

* async execution of linters / fixers
* list of integrations is huge

### Shortcuts

```
<leader> - <space>
```

#### Tabs

```
<leader>tt - new tab
<leader>tp - go to prev tab
<leader>tn - go to next tab
<leader>to - close all tabs expect current one

<leader>1 - go to 1 tab
<leader>2 - go to 2 tab
.
<leader>n - go to nth tab
<leader>0 - go to last tab
```

#### Splits

```
<c-h> - go to left split
<c-j> - go to bottom split
<c-k> - go to top split
<c-l> - go to left split
<c-\> - go between split
<c-w>o - close all splits except focused one
```

#### File explorer

While buffer is in focus:
```
<leader>fe - toggle file tree
<leader>ff - find current file
```

While the file tree is in focus:
```
t - open file in new tab
i - open file in a hsplit
s - open file in a vsplit
o / enter - open file in the main buffer
```

#### File path / name

```
<leader>cfn - copy current filename to clipboard
<leader>cfp - copy current filepath to clipboard
```

#### Search

```
<ctrl>p - search files by filename
<ctrl>f - search files by content
<ctrl>b - search buffers by filename
```

#### Lint / Format

```
<leader>al - lint
<leader>af - fix
<leader>ad - error details
```

#### Git

```
<leader>gpr - git pull -r
<leader>gc - git commit
<leader>gp - git push
<leader>gb - git blame
<leader>gl - git log
<leader>gd - git diff in vertical split
```

## Zsh

ZSH - highly customizable shell, supports custom color scheme, aliases, completions.

### Plugins

[zplug][Zplug Github] - plugin manager used to simplify plugin management. Can manage all types of plugins (git, oh-my-zsh, gist files), parallel installation, lazy loading.

* dracula/zsh - color scheme
* plugins/vi-mode - adds vim keybinding
* plugins/fzf - fuzzy finder for command history

* zsh-users/zsh-autosuggestions - suggests commands from history after cursor in a shadow gray color
* zsh-users/zsh-completions - additional completion definitions
* zsh-users/zsh-syntax-highlighting - highlightes commands as you type
* zsh-users/zsh-history-substring-search - history search by subscript

```zsh
zplug "dracula/zsh", as:theme
zplug "plugins/vi-mode", from:oh-my-zsh
zplug "plugins/fzf", from:oh-my-zsh

zplug "zsh-users/zsh-autosuggestions"
zplug "zsh-users/zsh-completions", depth:1
zplug "zsh-users/zsh-syntax-highlighting", defer:2
zplug "zsh-users/zsh-history-substring-search", defer:3
```

[Neovim Github]: https://github.com/neovim/neovim
[VimPlug Github]: https://github.com/junegunn/vim-plug
[Nerdtree Github]: https://github.com/scrooloose/nerdtree
[FZF Github]: https://github.com/junegunn/fzf
[FZF Vim Github]: https://github.com/junegunn/fzf.vim
[Ripgrep Github]: https://github.com/BurntSushi/ripgrep
[YCM Github]: https://github.com/ycm-core/YouCompleteMe
[Ale Github]: https://github.com/dense-analysis/ale
[Vim Fugitive Github]:https://github.com/tpope/vim-fugitive
[Vim GitGutter Github]: https://github.com/airblade/vim-gitgutter
[GV Github]: https://github.com/junegunn/gv.vim
[Tmux Github]: https://github.com/tmux/tmux
[Alacritty Github]: https://github.com/jwilm/alacritty
[env-automation]: https://github.com/atsman/env-automation
[Zplug Github]: https://github.com/zplug/zplug
